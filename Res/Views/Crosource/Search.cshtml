@{
	ViewBag.Title = "查询作品";

	var user = ResSettings.SettingsInSession.User;
}
<div class="col-md-10 content-wrapper">
	<div class="row">
		<div class="col-lg-4 ">
			<ul class="breadcrumb">
				<li>
					<i class="fa fa-home"></i>
					<a href="@Url.Action("Index", "Home")">首页</a>
				</li>
				<li><a href="@Url.Action("Index", "Crosource")">作品</a></li>
				<li class="active">@ViewBag.Title</li>
			</ul>
		</div>
	</div>

	<!-- main -->
	<div class="content">
		<div class="main-header">
			<h2>@ViewBag.Title</h2>
			<em>按名称查询作品</em>
		</div>

		<div class="main-content">

			<div style="margin-bottom:10px;"><a href="@Url.Action("Edit", "Crosource")" id="addUser" class="btn btn-danger btn-md">新增作品</a>&nbsp;
			<a href="#" id="addUser" class="btn btn-info btn-approve">审核</a>&nbsp;
			<a href="#" id="addUser" class="btn btn-success btn-approve">设置奖项</a>&nbsp;
			<a href="#" id="addUser" class="btn btn-primary btn-approve">公开设置</a>&nbsp;
			<a href="#" id="addUser" class="btn btn-default btn-approve">下载设置</a></div>
			<!-- widget -->
			<div class="widget">
				<div class="widget-header">
					<h3><i class="fa fa-paperclip"></i> @ViewBag.Title</h3>
					<div class="btn-group widget-header-toolbar">
						<a href="#" title="专注" class="btn-borderless btn-focus"><i class="fa fa-eye"></i></a>
					</div>
				</div>

				<div class="widget-content">

					<div class="row">
						<div class="col-sm-2">
							@Html.DropDownList("Active", (ViewBag.Actives as List<Active>).Select(x => new SelectListItem { Text = x.ActiveName, Value = x.ActiveId.ToString() }), "选择项目", new { @class = "search-field form-control" })
						</div>
						<div class="col-sm-2">
							@Html.DropDownList("Province", (ViewBag.Provinces as List<ResCompany>).Select(x => new SelectListItem { Text = x.CompanyName, Value = x.CompanyId.ToString() }), "选择省份", new { @class = "search-field form-control" })
						</div>
						<div class="col-sm-2">
							@Html.DropDownList("Area", (ViewBag.Areas as List<ResCompany>).Select(x => new SelectListItem { Text = x.CompanyName, Value = x.CompanyId.ToString() }), "选择地区", new { @class = "search-field form-control" })
						</div>
						<div class="col-sm-2">
							@Html.DropDownList("Company", (ViewBag.Companies as List<ResCompany>).Select(x => new SelectListItem { Text = x.CompanyName, Value = x.CompanyId.ToString() }), "选择单位", new { @class = "search-field form-control" })
						</div>
						<div class="col-sm-2">
							@Html.DropDownList("Grade", CroResourceHelper.Grade.GetSelectList(), "选择年级", new { @class = "form-control" })
						</div>
						<div class="col-sm-2">
							@Html.DropDownList("Subject", CroResourceHelper.Subject.GetSelectList(), "选择学科", new { @class = "form-control" })
						</div>

					</div>

					<!-- Grid -->
					<div id="table-responsive">
						<table id="bootgrid" class="table table-striped table-hover">
							<thead>
								<tr>
									<th data-column-id="Title" data-formatter="LookupResource" >作品名称</th>
									<th data-column-id="Author">上传作者</th>
									<th data-column-id="Type">作品类型</th>
									<th data-column-id="Province">省份</th>
									<th data-column-id="Area">地区</th>
									<th data-column-id="School">单位</th>
									@*<th data-column-id="CreatedTime">上传日期</th>*@
									<th data-column-id="WinLevel">获奖等级</th>
									<th data-column-id="Score">作品得分</th>
									<th data-column-id="State">状态</th>
									<th data-column-id="cmd_approve" data-formatter="cmd_approve" data-sortable="false" data-headercs="cmdwidth"></th>
									<th data-column-id="cmd_elite" data-formatter="cmd_elite" data-sortable="false" data-headercs="cmdwidth"></th>
									<th data-column-id="cmd_public" data-formatter="cmd_public" data-sortable="false" data-headercs="cmdwidth"></th>
									<th data-column-id="cmd_download" data-formatter="cmd_download" data-sortable="false" data-headercs="cmdwidth"></th>
									<th data-column-id="cmd_delete" data-formatter="cmd_delete" data-sortable="false" data-headercs="cmdwidth"></th>
								</tr>
							</thead>
						</table>
					</div>
					<!-- end Grid-->
				</div>
				<!-- end widget content -->

			</div>
			<!-- end widget -->
			<!-- modal frame -->
			<div class="modal fade" id="inner-edit-form" tabindex="-1" role="dialog"></div>
			<!-- end modal frame -->

		</div>
		<!-- /main-content -->
	</div>
	<!-- /main -->
</div>
@section Css {
	@Styles.Render("~/css/bootgrid")
}
@section Plugins {
	@Scripts.Render("~/js/bootgrid")
}
@section Scripts {
	<script type="text/javascript">

		function RelationSelect(src, tat, rule, none, fixInit) {
			var $src = $(src), $tat = $(tat);
			function doit(init) {
				var key = $src.val();
				$tat.empty();
				if (none) {
					$tat.append($("<option>").val(0).text(none)).change();
				}
				$.each(rule, function (i, n) {
					if (n.key == key) {
						$tat.append($("<option>").val(n.id).text(n.name));
					}
				});
				if (init) $tat.val(init);
			}

			$src.on("change", function () {
				doit();
			});

			doit(fixInit || $tat.val());
		}

		function getGlobalRequest() {
			return {
				activeId: $('#Active').val()=='' ? 0:$('#Active').val(),
				provinceId: $('#Province').val()=='' ? 0:$('#Province').val(),
				areaId: $('#Area').val()=='' ? 0:$('#Area').val(),
				companyId: $('#Company').val()=='' ? 0:$('#Company').val(),
				subjectId: $('#Subject').val()=='' ? 0:$('#Subject').val(),
				gradeId: $('#Grade').val()=='' ? 0:$('#Grade').val(),
			};
		}



		function getGridOptions() {
			var userType = '@user.UserTypePKID';
			var isAdmin = userType != '@ResUserHelper.RegistedUser' && userType != '@ResUserHelper.Export';

			return $.extend(true, {}, gridOptions, {

				url: "/Crosource/Search",

				requestHandler: function (request) { return $.extend(true, request, getGlobalRequest()); },

				formatters: {
					"LookupResource": function (column, row) {
						var text = row[column.id], url = '/Crosource/Details/' + row["id"];
						return "<span class='elitedot'>【奖】</span><a href='" + url + "'>" + text + "</a>";
					},
					"cmd_approve": function (column, row) {
						if (isAdmin) {
							return "<button type='button' class='btn btn-xs " + (row["StatePKID"] == 10352 ? "isallow" : "") + " cmd_approve' data-row-id='" + row.id + "' data-row-title='" + row.Title + "' title='审核合格/不合格'><span class='fa fa-gavel'></span></button>";
						}
					},
					"cmd_elite": function (column, row) {
						if (isAdmin) {
							return "<button type='button' class='btn btn-xs " + (row["WinLevelPKID"] > 0 ? "iselite" : "") + " cmd_elite' data-row-id='" + row.id + "' data-row-title='" + row.Title + "' title='设置奖项'><fa>奖</fa></button>";
						}
					},
					"cmd_public": function (column, row) {
						if (isAdmin) {
							return "<button type='button' class='btn btn-xs cmd_public' data-row-id='" + row.id + "' data-row-title='" + row.Title + "' title='公开/不公开'><fa>" + (row["PublicStatePKID"] == 10450 ? "取消公开" : "公开") + "</fa></button>";
						}
					},
					"cmd_download": function (column, row) {
						if (isAdmin) {
							return "<button type='button' class='btn btn-xs  cmd_download' data-row-id='" + row.id + "' data-row-title='" + row.Title + "' title='下载/禁止下载'><fa>" + (row["DownloadStatePKID"] == 10452 ? "下载" : "禁止下载") + "</fa></button>";
						}
					},
					"cmd_delete": function (column, row) {
						return "<button type='button' class='btn btn-xs cmd_delete' data-row-id='" + row.id + "' data-row-title='" + row.Title + "' title='删除'><span class='fa fa-trash-o'></span></button>";
					},
				},

				defaultSearch: decodeURI(window.location.search.substr(3)),

				labels: {
					search: "名称搜索"
				},

			});

		}


		$(function () {

			var provinces=@Html.Raw(Json.Encode(ViewBag.ProvincesDic));
			var areas=@Html.Raw(Json.Encode(ViewBag.AreasDic));
			var schools=@Html.Raw(Json.Encode(ViewBag.SchoolsDic));

			// relation select
			RelationSelect($("#Province"), $("#Area"), areas, "选择地区");
			RelationSelect($("#Area"), $("#Company"), schools, "选择学校");

			var grid = $("#bootgrid")
					.bootgrid(getGridOptions())
					.on("loaded.rs.jquery.bootgrid", function () {

						initTableCheckbox();

						grid.find("tbody tr:has(button.iselite)").addClass("flagelite");
						grid.find("tbody tr:has(button.isallow)").addClass("flagallow");

						grid
							.find(".cmd_approve").on("click", function (e) {
								var id = $(this).data("row-id"),
									 title = $(this).data("row-title"),
									 tr = $(this).parent().parent(),
									 value = tr.hasClass("flagallow"),
									 brother = $(this).parent().prev();
								message = value ? "审核该作品为 - 不合格" : "审核该作品为 - 合格";
								alertify.prompt("审核意见", function (e, str) {
									if (e) {
										$.post("/Crosource/Approve", { id: id, value: !value, opinion: str }, function (data, status) {
											alertify.success("作品 【" + title + "】 审核完成。");
											tr.toggleClass("flagallow");
											brother.text(!value ? "审核合格" : "审核不合格");
										});
									} else {
										alertify.success("作品 【" + title + "】 审核取消。");
									}
								}, message);
							}).end()

							// 设置作品奖项级别
							.find(".cmd_elite").on("click", function (e) {
								var id = $(this).data("row-id");
								$.post("@Url.Action("WinLevel", "Crosource")", { id: id }, function (response) {
									$("#inner-edit-form")
										.html(response).modal("show");
								});
							}).end()

							// 删除作品
							.find(".cmd_delete").on("click", function (e) {
								var id = $(this).data("row-id"), title = $(this).data("row-title");
								var msg = "确认要删除作品 【" + title + "】 吗？";
								alertify.confirm(msg, function (e) {
									if (e) {
										$.post("/Crosource/Delete", { id: id }, function (data, status) {
											if (data.cmd == "Deleted") { alertify.success(data.msg); grid.bootgrid("reload"); }
											else { alertify.error(data.msg); }
										});
									}
								});
							}).end()

							// 公开设置
							.find(".cmd_public").on("click", function () {
								var id = $(this).data("row-id");
								$.post("/Crosource/PublicSetting", { id: id }, function (data, status) {
									if (data.cmd == "Updated") { alertify.success(data.msg); grid.bootgrid("reload"); }
									else { alertify.error(data.msg); }
								});
							}).end()

							// 下载设置
							.find(".cmd_download").on("click", function () {
								var id = $(this).data("row-id");
								$.post("/Crosource/DownloadSetting", { id: id }, function (data, status) {
									if (data.cmd == "Updated") { alertify.success(data.msg); grid.bootgrid("reload"); }
									else { alertify.error(data.msg); }
								});
							}).end();

					});

			

			$('.search').css('width','310px');
			$('.search input').prop('placeholder','作品名称，内容，作者名称或作者单位');

		});

	</script>

}